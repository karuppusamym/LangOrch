{
  "$schema_name": "CKP Syntax Reference (informal)",
  "$schema_version": "2026-02-09",
  "$min_orchestrator_version": "1.0.0",
  "$disclaimer": {
    "purpose": "Human/LLM guidance only",
    "authoritative_runtime_contract": "backend/app/compiler + backend/app/runtime",
    "not_for": [
      "Direct strict validation",
      "Inferring runtime behavior over implemented code"
    ]
  },
  "$notes": [
    "This file is a human-friendly syntax/shape reference for CKP JSON files.",
    "It is valid JSON and intended for understanding/documentation, not strict runtime validation.",
    "Variable templating uses {{var_name}} placeholders inside strings.",
    "Keep node ids unique. Graph edges use start_node / next_node / default_next_node / body_node / branches.start_node.",
    "Canonical executable examples live in sample_workflow_multi_agent.json and sample_web_playwright_demo.json.",
    "Supports multi-agent orchestration: WEB, DESKTOP, LLM, EMAIL, API, DATABASE, and extensibility.",
    "Production concerns include checkpoints, human-in-the-loop, telemetry, and audit trails."
  ],
  "root": {
    "procedure_id": "string (unique)",
    "version": "string (semver)",
    "status": "one_of: active|draft|approved|inactive",
    "effective_date": "string (YYYY-MM-DD)",
    "description": "string",
    "trigger": {
      "type": "one_of: manual|scheduled|webhook|event|file_watch",
      "schedule": "string (cron expression, optional)",
      "webhook_config": {
        "endpoint": "string (optional)",
        "authentication": "object (optional)",
        "allowed_sources": "string[] (optional)"
      },
      "event_config": {
        "event_source": "string (optional)",
        "event_filter": "object (optional)",
        "event_type": "string[] (optional)"
      },
      "file_watch_config": {
        "path": "string (optional)",
        "pattern": "string (glob, optional)",
        "event_types": "string[] (created|modified|deleted, optional)"
      }
    },
    "retrieval_metadata": {
      "primary_intents": "string[]",
      "negative_intents": "string[]",
      "business_domain": "one_of: finance|hr|it|ops",
      "applicability": {
        "application_names": "string[]",
        "account_types": "string[]",
        "channel": "string[] (e.g., web|desktop|api|mainframe)"
      },
      "keywords": "string[]"
    },
    "global_config": {
      "screenshot_on_fail": "boolean",
      "max_retries": "number",
      "retry_delay_ms": "number (optional)",
      "timeout_ms": "number",
      "on_failure": "string (node_id, optional)",
      "logging_level": "one_of: DEBUG|INFO|WARNING|ERROR (optional)",
      "telemetry_enabled": "boolean (optional)",
      "checkpoint_strategy": "one_of: every_node|critical_nodes_only|disabled (optional)",
      "checkpoint_storage": "one_of: local|database|cloud (optional)",
      "resume_on_failure": "boolean (optional)",
      "checkpoint_retention_days": "number (optional)",
      "execution_mode": "one_of: production|dry_run|validation_only (optional)",
      "mock_external_calls": "boolean (optional)",
      "test_data_overrides": "object (optional)",
      "rate_limiting": {
        "enabled": "boolean (optional)",
        "max_requests_per_minute": "number (optional)",
        "max_concurrent_operations": "number (optional)"
      },
      "secrets_config": {
        "provider": "one_of: azure_keyvault|aws_secrets|hashicorp_vault|env_vars (optional)",
        "vault_url": "string (optional)",
        "secret_references": "object (optional)"
      },
      "audit_config": {
        "enabled": "boolean (optional)",
        "audit_level": "one_of: minimal|standard|detailed (optional)",
        "storage_location": "string (optional)",
        "retention_days": "number (optional)",
        "include_sensitive_data": "boolean (optional)"
      }
    },
    "variables_schema": {
      "required": {
        "<var_name>": {
          "type": "one_of: string|number|boolean|array|object",
          "description": "string",
          "origin": "one_of: user_strict",
          "default": "any (optional)",
          "validation": {
            "regex": "string (optional)",
            "min": "number (optional)",
            "max": "number (optional)",
            "allowed_values": "any[] (optional)",
            "sensitive": "boolean (optional)"
          }
        }
      },
      "optional": {
        "<var_name>": {
          "type": "one_of: string|number|boolean|array|object",
          "origin": "one_of: user_lazy|system_captured",
          "description": "string",
          "default": "any (optional)"
        }
      }
    },
    "workflow_graph": {
      "start_node": "string (node_id)",
      "nodes": "{ [node_id]: node_definition }"
    },
    "provenance": {
      "compiled_on": "string (ISO timestamp)",
      "compiler_agent_version": "string",
      "human_reviewer": "string (optional)",
      "sources": [
        {
          "doc_id": "string",
          "version": "string",
          "section_ref": "string (optional)"
        }
      ]
    }
  },
  "node_definition": {
    "agent": "one_of: MasterAgent|WEB|DESKTOP|LLMAgent|EMAIL|API|DATABASE (optional for terminate)",
    "type": "one_of: sequence|logic|loop|parallel|processing|verification|llm_action|terminate|subflow|human_approval|transform",
    "description": "string (recommended)",
    "inputs": "object (optional; values may include {{vars}})",
    "outputs": "object (optional; see output_mapping)",
    "next_node": "string|null (node_id)",
    "is_checkpoint": "boolean (optional)",
    "sla": {
      "max_duration_ms": "number (optional)",
      "on_breach": "one_of: warn|fail|escalate (optional)",
      "escalation_handler": "string (node_id, optional)"
    },
    "telemetry": {
      "track_duration": "boolean (optional)",
      "track_retries": "boolean (optional)",
      "custom_metrics": "object|array (optional)",
      "trace_id": "string (optional)",
      "span_id": "string (optional)"
    },
    "idempotency_key": "string (optional; ensure safe retries)"
  },
  "node_type_payloads": {
    "sequence": {
      "steps": "step[]",
      "validations": "validation_check[] (optional)",
      "error_handlers": "error_handler[] (optional)"
    },
    "logic": {
      "rules": [
        {
          "condition": "string (expression)",
          "next_node": "string (node_id)"
        }
      ],
      "default_next_node": "string (node_id)"
    },
    "loop": {
      "iterator": "string (array var name)",
      "iterator_variable": "string",
      "index_variable": "string (optional)",
      "body_node": "string (node_id)",
      "collect_variable": "string (optional)",
      "max_iterations": "number (optional)",
      "continue_on_error": "boolean (optional)",
      "next_node": "string (node_id)"
    },
    "parallel": {
      "branches": [
        {
          "branch_id": "string",
          "start_node": "string (node_id)"
        }
      ],
      "wait_strategy": "one_of: all|any|first (optional)",
      "branch_failure": "one_of: continue|stop|retry (optional)",
      "next_node": "string (node_id)"
    },
    "processing": {
      "operations": "operation[]",
      "next_node": "string (node_id)"
    },
    "verification": {
      "checks": "verification_check[]",
      "next_node": "string (node_id)"
    },
    "llm_action": {
      "prompt": "string (can include {{vars}})",
      "model": "string",
      "temperature": "number (optional)",
      "max_tokens": "number (optional)",
      "attachments": "llm_attachment[] (optional)",
      "retry": {
        "max_retries": "number (optional)",
        "delay_ms": "number (optional)"
      },
      "outputs": "object (optional)",
      "next_node": "string (node_id)"
    },
    "terminate": {
      "status": "one_of: success|failed",
      "cleanup_actions": "operation[] (optional)",
      "error_actions": "operation[] (optional)",
      "outputs": "object (optional)",
      "final_audit_log": "object (optional)"
    },
    "human_approval": {
      "prompt": "string",
      "decision_type": "one_of: approve_reject|select_option|provide_input",
      "options": "string[] (optional)",
      "timeout_ms": "number (optional)",
      "timeout_action": "one_of: auto_approve|auto_reject|escalate (optional)",
      "escalation_contact": "string (optional)",
      "context_data": "object (optional)",
      "approval_level": "one_of: standard|manager|executive (optional)",
      "on_approve": "string (node_id)",
      "on_reject": "string (node_id)",
      "on_timeout": "string (node_id, optional)"
    },
    "transform": {
      "transformations": [
        {
          "type": "one_of: filter|map|reduce|join|aggregate|pivot|sort|deduplicate",
          "source_variable": "string",
          "expression": "string",
          "output_variable": "string",
          "params": "object (optional)"
        }
      ],
      "next_node": "string (node_id)"
    },
    "subflow": {
      "procedure_id": "string",
      "version": "string (optional)",
      "input_mapping": "object",
      "output_mapping": "object",
      "on_failure": "one_of: fail_parent|continue|retry (optional)",
      "inherit_context": "boolean (optional)",
      "next_node": "string (node_id)"
    }
  },
  "step": {
    "step_id": "string (recommended)",
    "action": "string (see action_catalog)",
    "target": "string (optional)",
    "value": "any (optional)",
    "wait_ms": "number (optional)",
    "duration_ms": "number (optional)",
    "timeout_ms": "number (optional)",
    "wait_after_ms": "number (optional)",
    "title": "string (optional)",
    "text": "string (optional)",
    "keys": "string[] (optional)",
    "cell": "string (optional)",
    "file_path": "string (optional)",
    "sheet_name": "string (optional)",
    "output_variable": "string (optional)",
    "connection_string": "string (optional)",
    "query": "string (optional)",
    "parameters": "object (optional)",
    "headers": "object (optional)",
    "method": "string (optional)",
    "url": "string (optional)",
    "body": "any (optional)",
    "retry_on_failure": "boolean (optional)",
    "screenshot_on_complete": "boolean (optional)"
  },
  "action_catalog": {
    "generic": [
      "wait",
      "screenshot",
      "log",
      "set_checkpoint",
      "restore_checkpoint"
    ],
    "desktop": [
      "launch_app",
      "activate_window",
      "wait_for_window",
      "wait_for_dialog",
      "click",
      "type",
      "press_key",
      "press_keys",
      "copy_to_clipboard",
      "paste_from_clipboard",
      "select_all_results",
      "click_cell",
      "read_excel_file",
      "close_window",
      "maximize_window",
      "minimize_window"
    ],
    "web": [
      "navigate",
      "wait_for_element",
      "click",
      "type",
      "clear",
      "extract_table_data",
      "wait_for_text",
      "scroll_to_element",
      "take_screenshot",
      "execute_javascript",
      "switch_frame",
      "switch_window",
      "upload_file",
      "download_file"
    ],
    "email": [
      "compose_email",
      "send_email",
      "read_email",
      "search_email",
      "download_attachment"
    ],
    "api": [
      "http_request",
      "graphql_query",
      "soap_request",
      "websocket_connect"
    ],
    "database": [
      "execute_query",
      "execute_procedure",
      "bulk_insert",
      "bulk_update",
      "transaction_begin",
      "transaction_commit",
      "transaction_rollback",
      "backup_data",
      "restore_data"
    ],
    "file": [
      "read_file",
      "write_file",
      "delete_file",
      "move_file",
      "copy_file",
      "list_directory",
      "create_directory",
      "zip_files",
      "unzip_files"
    ]
  },
  "operation": {
    "action": "one_of: set_variable|append_to_array|parse_excel_data|parse_json|parse_xml|parse_csv|calculate|format_string|extract_regex|notify|log|encrypt|decrypt|hash|validate_schema|convert_type",
    "variable": "string (for set_variable)",
    "value": "any",
    "array": "string (for append_to_array)",
    "expression": "string",
    "source": "string (often {{var}})",
    "pattern": "string",
    "output_variable": "string",
    "channel": "string",
    "recipients": "string[]|{{var}}",
    "subject": "string (optional)",
    "message": "string (optional)",
    "level": "one_of: DEBUG|INFO|WARNING|ERROR",
    "schema": "object (optional)",
    "algorithm": "string (optional)",
    "key_reference": "string (optional)",
    "target_type": "string (optional)"
  },
  "output_mapping": {
    "$notes": [
      "Outputs map keys into state based on capture/mapping expressions."
    ],
    "examples": {
      "llm_raw": "llm_response",
      "field_from_llm_json": "json_extract: confidence",
      "regex_capture": "regex: Result ID: (\\d+)",
      "xpath_capture": "xpath://div[@id='result']"
    }
  },
  "validation_check": {
    "id": "string",
    "check": "one_of: screen_text_contains|element_exists|value_in_range|custom",
    "expected_values": "any[] (optional)",
    "condition": "string (optional)",
    "on_failure": "one_of: throw_exception|retry_node|fail_workflow",
    "message": "string (optional)"
  },
  "error_handler": {
    "error_type": "string",
    "action": "one_of: retry|screenshot_and_fail|fail|ignore|escalate",
    "max_retries": "number (optional)",
    "delay_ms": "number (optional)",
    "retry_policy": {
      "strategy": "one_of: fixed|exponential_backoff|fibonacci|linear (optional)",
      "base_delay_ms": "number (optional)",
      "max_delay_ms": "number (optional)",
      "multiplier": "number (optional)",
      "jitter": "boolean (optional)"
    },
    "trigger": {
      "error_text_contains": "string (optional)",
      "error_code": "string|number (optional)",
      "http_status_codes": "number[] (optional)"
    },
    "recovery_strategy": "one_of: retry_node|continue|stop|fallback_node (optional)",
    "recovery_steps": "step[] (optional)",
    "fallback_node": "string (node_id, optional)",
    "notify_on_error": "boolean (optional)",
    "error_metadata": "object (optional)"
  },
  "verification_check": {
    "id": "string",
    "condition": "string (expression)",
    "on_fail": "one_of: fail_workflow|warn|continue",
    "message": "string"
  },
  "llm_attachment": {
    "type": "one_of: image|csv|text|json",
    "source": "string (file path or {{var}})",
    "description": "string (optional)"
  },
  "compatibility_note": {
    "runtime_contract": "Treat this as documentation only. The executing parser/validator in backend code is the source of truth.",
    "non_goals": [
      "Does not change CKP runtime behavior",
      "Does not alter sample_workflow_multi_agent.json",
      "Does not alter backend compiler or executor code"
    ]
  }
}